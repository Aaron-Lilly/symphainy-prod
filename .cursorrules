# Symphainy Platform - Cursor Rules

**Status:** Canonical (Locked — January 2026)  
**Applies to:** All code, tests, and documentation

---

## Architecture Principles

### Platform Philosophy
> **Symphainy is a governed execution platform.**
> It runs **Solutions** safely — and those Solutions safely operate, connect to, and reason over external systems.

### Core Principles
1. **Runtime owns execution** - Nothing executes without Runtime's knowledge
2. **Intent-based architecture** - All operations expressed as intents
3. **Public Works pattern** - All infrastructure via abstractions
4. **Multi-tenant safety** - Built-in tenant isolation
5. **Working code only** - No stubs, placeholders, or cheats

---

## Code Patterns

### Role = What, Service = How
- **Roles** define WHAT is being done (e.g., "I orchestrate file ingestion")
- **Services** define HOW it's done (e.g., "I coordinate upload, parsing, and storage")
- **Agents** add autonomy for agency and predictability

### Intent-Based Execution
All operations flow through Runtime as intents:
```python
intent = IntentFactory.create_intent(
    intent_type="ingest_file",
    tenant_id=tenant_id,
    session_id=session_id,
    solution_id=solution_id,
    parameters={...}
)
result = await execution_manager.execute(intent)
```

### Public Works Pattern
All infrastructure access via abstractions:
```python
# ✅ CORRECT - Use abstraction
file_storage = public_works.get_file_storage_abstraction()
await file_storage.upload_file(...)

# ❌ WRONG - Direct adapter access
await gcs_adapter.upload(...)  # Anti-pattern!
```

### Runtime Participation Contract
All realm orchestrators must:
1. Declare supported intents
2. Handle intents with execution context
3. Return artifacts and events
4. Use Public Works abstractions (no direct infrastructure)

---

## File Structure

```
symphainy_platform/
├── runtime/              # Runtime Plane - execution authority
├── civic_systems/       # Civic Systems - governance
│   ├── experience/      # Experience Plane
│   ├── agentic/         # Agent Foundation
│   └── platform_sdk/   # Platform SDK
├── realms/              # Realm Plane - domain services
│   ├── content/         # Content Realm
│   ├── insights/        # Insights Realm
│   ├── journey/         # Journey Realm
│   └── outcomes/        # Outcomes Realm
└── foundations/         # Foundations - infrastructure
    └── public_works/     # Public Works abstractions
```

---

## Anti-Patterns (FORBIDDEN)

### ❌ Direct Infrastructure Access
```python
# WRONG - Direct adapter access in business logic
await redis_client.set(key, value)

# CORRECT - Use abstraction
await state_abstraction.store_state(key, value)
```

### ❌ Stubs and Placeholders
```python
# WRONG - Stub implementation
async def process_file(self):
    pass  # TODO: implement

# CORRECT - Working implementation
async def process_file(self):
    # Real implementation that works
    result = await self._process_file_internal()
    return result
```

### ❌ Execution Outside Runtime
```python
# WRONG - Direct execution in realm
await self.database.execute(query)

# CORRECT - Return intent for Runtime execution
return {
    "artifacts": {"query": query},
    "events": [{"type": "query_prepared"}]
}
```

### ❌ Orchestration in Realms
```python
# WRONG - Orchestration logic in realm
async def handle_intent(self, intent, context):
    result1 = await self.step1()
    result2 = await self.step2(result1)
    return result2

# CORRECT - Use Runtime sagas for orchestration
async def handle_intent(self, intent, context):
    # Return artifacts, let Runtime orchestrate
    return {"artifacts": {...}, "events": [...]}
```

---

## Testing Requirements

### Test Principles
1. **Tests must fail if code has cheats** - No tests that pass with stubs
2. **Use real infrastructure** - Integration tests use docker-compose
3. **Test architecture compliance** - Verify Public Works pattern usage
4. **No skipped tests** - Unless explicitly documented why

### Test Structure
```
tests/
├── unit/              # Fast, isolated tests (mocked)
├── integration/       # Real infrastructure tests
└── e2e/              # Full platform tests
```

---

## Documentation Standards

### Required Documentation
1. **Architecture decisions** → `docs/architecture/decisions/ADR_*.md`
2. **Pattern usage** → `docs/architecture/patterns/*.md`
3. **Implementation status** → `docs/current_state/`
4. **API contracts** → `docs/execution/api_contracts_*.md`

### Documentation Principles
- **Current state over history** - Document what exists, not what changed
- **Single source of truth** - One authoritative document per topic
- **No duplicates** - Consolidate, don't proliferate

---

## Key Documents

- **Architecture:** `docs/architecture/north_star.md` (authoritative)
- **Platform Rules:** `docs/PLATFORM_RULES.md` (development standards)
- **Platform Overview:** `docs/PLATFORM_OVERVIEW.md` (executive overview)
- **Developer Guide:** `docs/00_START_HERE.md` (developer entry point)
- **Capabilities:** `docs/capabilities/00_CAPABILITIES_INDEX.md` (what platform can do)

---

## Common Tasks

### Adding a New Intent
1. Add intent type to `runtime/intent_model.py`
2. Implement handler in realm orchestrator
3. Register intent in realm's `declare_intents()`
4. Add tests (must fail if implementation has stubs)
5. Document in `docs/capabilities/`

### Adding a New Realm
1. Create realm directory in `realms/`
2. Implement `RealmBase` with `handle_intent()`
3. Declare supported intents
4. Use Public Works abstractions
5. Register with Runtime
6. Add tests and documentation

### Adding Infrastructure
1. Create adapter in `foundations/public_works/adapters/`
2. Create abstraction in `foundations/public_works/abstractions/`
3. Create protocol in `foundations/public_works/protocols/`
4. Register in `foundations/public_works/foundation_service.py`
5. Write tests (must fail if adapter has stubs)

---

## Remember

> **We're building a platform that works.**
> 
> No shortcuts.  
> No cheats.  
> No backwards compatibility baggage.  
> No tests that pass with stubs.
>
> **Working code only.**

If code conflicts with architecture guide, **architecture guide wins**.
