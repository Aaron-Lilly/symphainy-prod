# Cursor Rules for Symphainy Platform

## ðŸš¨ Critical Rules (Non-Negotiable)

### Breaking Changes Only
- **No backwards compatibility.** This is a new platform (v2.0).
- Archive old implementations, rebuild cleanly.
- No migration paths, no compatibility layers.

### Working Code Only
- **No stubs, placeholders, or cheats.**
- All code must work. No `pass`, `raise NotImplementedError`, `# TODO` (unless abstract method).
- No hard-coded values that should be configurable.
- No mock data in production code.

### Tests Must Be Real
- **No tests pass if code has cheats.**
- Tests must verify real functionality.
- Tests must fail if code has stubs/cheats.
- Integration tests test real integrations.

### Public Works Pattern
- **All infrastructure via Public Works abstractions.**
- Use `StateManagementAbstraction`, not direct Redis calls.
- Use `FileStorageAbstraction`, not direct GCS calls.
- Use adapters via abstractions, not directly.

### Architecture Guide Wins
- **If code conflicts with architecture guide, architecture guide is correct.**
- Code must follow architecture guide.
- If unsure, ask (don't guess).

---

## Platform Architecture

Symphainy is a **governed execution platform** that runs **Solutions** safely.

### Core Principles

1. **Platform-First, Not MVP-First**: Build the execution spine first, express use cases on top
2. **Execution Ownership**: Runtime owns execution, Curator owns capability registration, Realms compose logic, Agents reason
3. **Capability by Design, Enabled by Policy**: WAL, Saga, Zero Trust, multi-tenancy exist structurally from day one
4. **Breaking Changes Only**: No backwards compatibility. This is v2.0.
5. **Working Code Only**: No stubs, cheats, or placeholders.

### Architecture Layers

```
Runtime Execution Engine (Validation & State)
  â†“
Civic Systems (Behavior & Governance)
  â†“
Domain Services (Domain Execution)
  â†“
Public Works (Foundations)
```

### Directory Structure

```
symphainy_platform/
  runtime/          # Runtime Execution Engine - execution control, WAL, Saga, state
  civic_systems/    # Civic Systems - Smart City, Experience, Agentic, Platform SDK
  realms/           # Domain Services - Content, Insights, Operations, Outcomes
  foundations/      # Public Works - infrastructure abstractions and adapters
    public_works/   # Infrastructure abstractions (swappable)
      protocols/    # Contracts (Layer 2)
      abstractions/ # Business logic (Layer 1)
      adapters/     # Technology bindings (Layer 0)
```

**Note:** Package is named `symphainy_platform` (not `platform`) to avoid conflict with Python's built-in `platform` module.

---

## Key Patterns

### Runtime Execution Engine
- **Sessions**: First-class, tenant-scoped, required for all intents
- **State Surface**: Hot state (Redis) + Cold state (ArangoDB/Supabase)
- **WAL**: Redis Streams (append-only log for audit, replay, recovery)
- **Saga**: Async workflow coordination with compensation
- **Data Brain**: Runtime-native data cognition (references, not data)
- **Intent Ingestion**: Experience â†’ Runtime â†’ Realms

### Public Works Pattern
- **Protocols**: Define contracts (Layer 2)
- **Abstractions**: Business logic (Layer 1)
- **Adapters**: Technology bindings (Layer 0)
- **Swappability**: Swap adapters without changing business logic

### Domain Services (Realms)
- **Runtime Participation Contract**: `handle_intent(intent, runtime_context) â†’ { artifacts, events }`
- **No Direct State**: Use State Surface
- **No Orchestration**: Use Runtime sagas
- **No Direct Infrastructure**: Use Public Works abstractions

### Agents
- **GroundedReasoningAgentBase**: Fact gathering â†’ Reasoning â†’ Validation
- **No State Storage**: Agents request state from State Surface
- **No Side Effects**: Agents reason, Runtime executes
- **Tool Invocation**: Via Runtime, not direct

### Experience Plane
- **Submit Intents**: Experience submits, never runs logic
- **Stream State**: Experience streams state from Runtime
- **Separate Service**: Experience is a separate service, not mounted on Runtime

---

## Code Style

- **Python 3.10+**: Use type hints, async/await
- **Protocols for Contracts**: Use `typing.Protocol` for contracts
- **Dataclasses for Data**: Use `@dataclass` for structured data
- **Async First**: All I/O operations are async
- **Type Safety**: Use type hints everywhere, validate with mypy

---

## Testing

- **pytest**: Test framework
- **Markers**: `@pytest.mark.unit`, `@pytest.mark.integration`, `@pytest.mark.e2e`
- **Fixtures**: Use `conftest.py` for shared fixtures
- **Test Structure**: `tests/unit/`, `tests/integration/`, `tests/e2e/`
- **No Cheats**: Tests must fail if code has stubs/cheats

---

## Anti-Patterns (Forbidden)

### Code Anti-Patterns
- âŒ **Stubs:** `pass`, `raise NotImplementedError`, `# TODO` (unless abstract method)
- âŒ **Cheats:** Hard-coded values, mock data in production code
- âŒ **Placeholders:** Unresolved placeholders that persist
- âŒ **Direct Infrastructure:** Direct Redis/DB calls in business logic
- âŒ **Architectural Violations:** Code that doesn't match architecture guide
- âŒ **Backwards Compatibility:** Supporting old patterns

### Test Anti-Patterns
- âŒ **Tests That Pass with Cheats:** Tests that pass when code has stubs
- âŒ **Mock Everything:** Tests that mock all dependencies (no real integration)
- âŒ **Skipped Tests:** Tests marked as skipped without good reason

### Process Anti-Patterns
- âŒ **Pragmatic Deviations:** "Just this once" architectural violations
- âŒ **Temporary Solutions:** Solutions that become permanent
- âŒ **Backwards Compatibility:** Supporting old patterns "just in case"

---

## When Adding New Code

1. **Check Architecture**: Does it belong in Runtime, Civic Systems, Realms, or Public Works?
2. **Use Contracts**: Implement Protocol-based contracts
3. **Use Public Works**: All infrastructure via Public Works abstractions
4. **Write Working Code**: No stubs, no cheats, no placeholders
5. **Write Tests**: Add unit/integration tests (tests must fail if code has cheats)
6. **Document**: Add docstrings explaining WHAT and HOW

---

## Import Paths

**Important:** Package is named `symphainy_platform` (not `platform`) to avoid conflict with Python's built-in `platform` module.

- âœ… Correct: `from symphainy_platform.runtime import Session`
- âŒ Wrong: `from platform.runtime import Session` (conflicts with built-in)

---

## Common Tasks

### Adding Infrastructure (Public Works)
1. Create adapter in `foundations/public_works/adapters/`
2. Create abstraction in `foundations/public_works/abstractions/`
3. Create protocol in `foundations/public_works/protocols/`
4. Register in `foundations/public_works/foundation_service.py`
5. Write tests (must fail if adapter has stubs)

### Adding a Domain Service (Realm)
1. Create service in `realms/{realm_name}/`
2. Implement Runtime Participation Contract
3. Use Public Works abstractions (no direct infrastructure)
4. Register with Curator
5. Write tests (must fail if service has stubs)

### Adding Runtime Component
1. Create component in `runtime/`
2. Follow architecture guide strictly
3. Use Public Works abstractions
4. Integrate with WAL, Saga, State Surface
5. Write tests (must fail if component has stubs)

---

## Questions to Ask

- **Where does this belong?** Runtime, Civic Systems, Realms, or Public Works?
- **Who owns execution?** Runtime owns execution, not realms/agents
- **Who owns state?** State Surface owns state, not services/agents
- **Is this infrastructure?** If yes, it belongs in Public Works
- **Does this have stubs/cheats?** If yes, fix it (no stubs allowed)
- **Does this match architecture guide?** If no, fix it

---

## References

- **Architecture Guide**: `docs/architecture/north_star.md`
- **Platform Rules**: `docs/PLATFORM_RULES.md`
- **Execution Plans**: `docs/execution/00_EXECUTION_INDEX.md`
- **Roadmap**: `docs/roadmap/00_ROADMAP_INDEX.md`
- **Start Here**: `docs/00_START_HERE.md`

---

## Remember

> **We're building a platform that works.**
> 
> No shortcuts.  
> No cheats.  
> No backwards compatibility baggage.  
> No tests that pass with stubs.
>
> **Working code only.**
