# Docker Compose Configuration for Full Stack Testing
#
# This configuration runs the complete Symphainy platform stack:
# - Traefik (API Gateway & WebSocket Proxy)
# - Backend (Runtime API)
# - Frontend (Next.js Application)
# - Infrastructure (Redis, ArangoDB, Consul, Meilisearch, GCS Emulator)
#
# Usage:
#   docker-compose -f docker-compose.fullstack.yml up --build
#
# Access Points:
#   Frontend: http://localhost:3000
#   Backend API: http://localhost:80/api
#   Traefik Dashboard: http://localhost:8080

version: '3.8'

services:
  # ==========================================================================
  # TRAEFIK - API Gateway & WebSocket Proxy
  # ==========================================================================
  traefik:
    image: traefik:v2.10
    container_name: symphainy-traefik
    ports:
      - "80:80"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - symphainy_net
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  # ==========================================================================
  # BACKEND - Symphainy Runtime
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.runtime
    container_name: symphainy-backend
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGODB_URL=http://arango:8529
      - ARANGODB_PASSWORD=symphainy_dev
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - MEILISEARCH_URL=http://meilisearch:7700
      - MEILISEARCH_MASTER_KEY=dev_master_key
      - GCS_EMULATOR_HOST=gcs-emulator:9023
      - ENVIRONMENT=development
      - PYTHONPATH=/app
    expose:
      - "8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=PathPrefix(`/api`) || PathPrefix(`/ws`)"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
    networks:
      - symphainy_net
    depends_on:
      redis:
        condition: service_healthy
      arango:
        condition: service_healthy
      consul:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ==========================================================================
  # FRONTEND - Next.js Application
  # ==========================================================================
  frontend:
    build:
      context: ./symphainy-frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_BACKEND_URL=http://traefik:80
        - NEXT_PUBLIC_API_URL=http://traefik:80/api
        - NEXT_PUBLIC_API_BASE_URL=http://traefik:80/api
    container_name: symphainy-frontend
    environment:
      - NEXT_PUBLIC_BACKEND_URL=http://traefik:80
      - NEXT_PUBLIC_API_URL=http://traefik:80/api
      - NEXT_PUBLIC_WS_URL=ws://traefik:80
      - NODE_ENV=production
    ports:
      - "3000:3000"
    networks:
      - symphainy_net
    depends_on:
      - traefik
      - backend
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ==========================================================================
  # INFRASTRUCTURE SERVICES
  # ==========================================================================
  
  redis:
    image: redis:7-alpine
    container_name: symphainy-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - symphainy_net
    restart: unless-stopped

  arango:
    image: arangodb:3.11
    container_name: symphainy-arango
    ports:
      - "8529:8529"
    environment:
      ARANGO_ROOT_PASSWORD: symphainy_dev
    volumes:
      - arango_data:/var/lib/arangodb3
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8529/_api/version || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - symphainy_net
    restart: unless-stopped

  consul:
    image: hashicorp/consul:latest
    container_name: symphainy-consul
    ports:
      - "8500:8500"
    command: agent -server -bootstrap-expect=1 -client=0.0.0.0 -ui
    volumes:
      - consul_data:/consul/data
    healthcheck:
      test: ["CMD", "consul", "info"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - symphainy_net
    restart: unless-stopped

  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: symphainy-meilisearch
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=dev_master_key
      - MEILI_ENV=development
    volumes:
      - meilisearch_data:/meili_data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - symphainy_net
    restart: unless-stopped

  gcs-emulator:
    image: fsouza/fake-gcs-server:latest
    container_name: symphainy-gcs
    ports:
      - "9023:9023"
    command: -scheme http -port 9023 -public-host localhost:9023 -backend memory
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9023/storage/v1/b"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - symphainy_net
    restart: unless-stopped

networks:
  symphainy_net:
    driver: bridge

volumes:
  redis_data:
  arango_data:
  consul_data:
  meilisearch_data:
