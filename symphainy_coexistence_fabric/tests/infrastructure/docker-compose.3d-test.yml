# Docker Compose for 3D Test Environment
# Spins up all services needed for integration and E2E tests
# Note: version is obsolete in newer docker-compose, removed

services:
  # Redis for state management
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ArangoDB for graph storage
  arangodb:
    image: arangodb:3.11
    environment:
      ARANGO_ROOT_PASSWORD: test_password
    ports:
      - "8529:8529"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8529/_api/version"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Consul for service discovery
  consul:
    image: hashicorp/consul:1.15
    ports:
      - "8500:8500"
    command: agent -dev -client=0.0.0.0
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Runtime Service
  runtime:
    build:
      context: ../..
      dockerfile: Dockerfile.runtime
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGO_URL=http://arangodb:8529
      - ARANGO_ROOT_PASSWORD=test_password
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - RUNTIME_PORT=8000
      - LOG_LEVEL=DEBUG
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_healthy
      arangodb:
        condition: service_healthy
      consul:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Experience Service
  experience:
    build:
      context: ../..
      dockerfile: Dockerfile.realms
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGO_URL=http://arangodb:8529
      - ARANGO_ROOT_PASSWORD=test_password
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - RUNTIME_URL=http://runtime:8000
      - EXPERIENCE_PORT=8001
      - LOG_LEVEL=DEBUG
    ports:
      - "8001:8001"
    depends_on:
      runtime:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 10

networks:
  default:
    name: symphainy-3d-test
