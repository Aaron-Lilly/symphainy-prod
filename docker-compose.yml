version: '3.8'
services:
  redis:
    image: redis:7-alpine
    container_name: symphainy-redis
    ports:
    - ${REDIS_PORT:-6379}:6379
    command: redis-server --appendonly yes
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
    - symphainy_net
  arango:
    image: arangodb:3.11
    container_name: symphainy-arango
    ports:
    - ${ARANGO_PORT:-8529}:8529
    environment:
      ARANGO_ROOT_PASSWORD: ${ARANGO_ROOT_PASSWORD:-changeme}
    volumes:
    - arango_data:/var/lib/arangodb3
    healthcheck:
      test:
      - CMD-SHELL
      - nc -z 127.0.0.1 8529 || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
    - symphainy_net
  consul:
    image: hashicorp/consul:latest
    container_name: symphainy-consul
    ports:
    - ${CONSUL_PORT:-8500}:8500
    environment:
    - CONSUL_BIND_INTERFACE=eth0
    - CONSUL_CLIENT_INTERFACE=eth0
    - CONSUL_DATACENTER=${CONSUL_DATACENTER:-dc1}
    - CONSUL_BOOTSTRAP_EXPECT=1
    - CONSUL_ACL_ENABLED=false
    volumes:
    - consul_data:/consul/data
    command: agent -server -bootstrap-expect=1 -client=0.0.0.0 -ui
    healthcheck:
      test:
      - CMD-SHELL
      - wget --no-verbose --tries=1 --spider http://localhost:8500/v1/status/leader || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
    - symphainy_net
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: symphainy-meilisearch
    ports:
    - ${MEILISEARCH_PORT:-7700}:7700
    environment:
    - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-master_key}
    - MEILI_ENV=production
    volumes:
    - meilisearch_data:/meili_data
    healthcheck:
      test:
      - CMD-SHELL
      - timeout 1 bash -c '</dev/tcp/127.0.0.1/8529' || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
    - symphainy_net
  runtime:
    build:
      context: .
      dockerfile: Dockerfile.runtime
    container_name: symphainy-runtime
    ports:
    - ${RUNTIME_PORT:-8000}:8000
    env_file:
    - symphainy_platform/.env.secrets
    environment:
    - REDIS_URL=${REDIS_URL:-redis://redis:6379}
    - ARANGO_URL=${ARANGO_URL:-http://arango:8529}
    - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
    - CONSUL_HOST=consul
    - CONSUL_PORT=8500
    - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
      arango:
        condition: service_healthy
      consul:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
    - symphainy_net
  experience:
    build:
      context: .
      dockerfile: Dockerfile.experience
    container_name: symphainy-experience
    ports:
    - ${EXPERIENCE_PORT:-8001}:8001
    env_file:
    - symphainy_platform/.env.secrets
    environment:
    - REDIS_URL=${REDIS_URL:-redis://redis:6379}
    - ARANGO_URL=${ARANGO_URL:-http://arango:8529}
    - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
    - CONSUL_HOST=consul
    - CONSUL_PORT=8500
    - RUNTIME_URL=http://runtime:8000
    - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      runtime:
        condition: service_healthy
      redis:
        condition: service_healthy
      arango:
        condition: service_healthy
      consul:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - timeout 1 bash -c '</dev/tcp/127.0.0.1/8001' || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
    - symphainy_net
  realms:
    build:
      context: .
      dockerfile: Dockerfile.realms
    container_name: symphainy-realms
    ports:
    - ${REALMS_PORT:-8002}:8002
    env_file:
    - symphainy_platform/.env.secrets
    environment:
    - REDIS_URL=${REDIS_URL:-redis://redis:6379}
    - ARANGO_URL=${ARANGO_URL:-http://arango:8529}
    - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
    - CONSUL_HOST=consul
    - CONSUL_PORT=8500
    - RUNTIME_URL=http://runtime:8000
    - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      runtime:
        condition: service_started
      redis:
        condition: service_healthy
      arango:
        condition: service_healthy
      consul:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - timeout 1 bash -c '</dev/tcp/127.0.0.1/8529' || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
    - symphainy_net
  otel-collector:
    image: otel/opentelemetry-collector:latest
    container_name: symphainy-otel-collector
    command:
    - --config=/etc/otel-collector-config.yaml
    volumes:
    - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
    - 4317:4317
    - 4318:4318
    depends_on:
    - tempo
    restart: unless-stopped
    networks:
    - symphainy_net
  prometheus:
    image: prom/prometheus:latest
    container_name: symphainy-prometheus
    volumes:
    - ./prometheus-config.yaml:/etc/prometheus/prometheus.yml
    - prometheus_data:/prometheus
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    ports:
    - ${PROMETHEUS_PORT:-9090}:9090
    restart: unless-stopped
    networks:
    - symphainy_net
  grafana:
    image: grafana/grafana:latest
    container_name: symphainy-grafana
    volumes:
    - grafana_data:/var/lib/grafana
    ports:
    - ${GRAFANA_PORT:-3000}:3000
    environment:
    - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    depends_on:
    - prometheus
    - tempo
    restart: unless-stopped
    networks:
    - symphainy_net
  tempo:
    image: grafana/tempo:latest
    container_name: symphainy-tempo
    ports:
    - ${TEMPO_PORT:-3200}:3200
    volumes:
    - ./tempo-config.yaml:/etc/tempo.yaml:ro
    - tempo_data:/var/tempo
    command:
    - -config.file=/etc/tempo.yaml
    restart: unless-stopped
    networks:
    - symphainy_net
  traefik:
    image: traefik:v2.10
    container_name: symphainy-traefik
    command:
    - --api.insecure=true
    - --providers.docker=true
    - --providers.docker.exposedbydefault=false
    - --entrypoints.web.address=:80
    ports:
    - ${TRAEFIK_PORT:-8080}:80
    - ${TRAEFIK_ADMIN_PORT:-8081}:8080
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
    - runtime
    - experience
    restart: unless-stopped
    networks:
    - symphainy_net
    labels:
    - traefik.enable=true
    - traefik.http.routers.runtime.rule=PathPrefix(`/api/runtime`) || PathPrefix(`/api/intent`) || PathPrefix(`/api/session`)
      || PathPrefix(`/api/execution`) || PathPrefix(`/api/realms`)
    - traefik.http.routers.runtime.entrypoints=web
    - traefik.http.routers.runtime.service=runtime
    - traefik.http.services.runtime.loadbalancer.server.port=8000
    - traefik.http.routers.runtime.priority=10
    - traefik.http.routers.runtime-health.rule=Path(`/health`) || Path(`/api/health`)
    - traefik.http.routers.runtime-health.entrypoints=web
    - traefik.http.routers.runtime-health.service=runtime
    - traefik.http.routers.runtime-health.priority=99
    - traefik.http.routers.experience.rule=PathPrefix(`/api/sessions`) || PathPrefix(`/api/intent`) || PathPrefix(`/api/ws`)
      || PathPrefix(`/api/admin`)
    - traefik.http.routers.experience.entrypoints=web
    - traefik.http.routers.experience.service=experience
    - traefik.http.services.experience.loadbalancer.server.port=8001
    - traefik.http.routers.experience.priority=10
    - traefik.http.routers.experience-health.rule=Path(`/health`)
    - traefik.http.routers.experience-health.entrypoints=web
    - traefik.http.routers.experience-health.service=experience
    - traefik.http.routers.experience-health.priority=99
volumes:
  redis_data: null
  arango_data: null
  consul_data: null
  meilisearch_data: null
  prometheus_data: null
  grafana_data: null
  tempo_data: null
networks:
  symphainy_net:
    driver: bridge
