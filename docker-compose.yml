services:
  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================
  
  redis:
    image: redis:7-alpine
    container_name: symphainy-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - symphainy_net

  arango:
    image: arangodb:3.11
    container_name: symphainy-arango
    ports:
      - "${ARANGO_PORT:-8529}:8529"
    environment:
      ARANGO_ROOT_PASSWORD: ${ARANGO_ROOT_PASSWORD:-changeme}
    volumes:
      - arango_data:/var/lib/arangodb3
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8529 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - symphainy_net

  consul:
    image: hashicorp/consul:latest
    container_name: symphainy-consul
    ports:
      - "${CONSUL_PORT:-8500}:8500"  # Consul HTTP API
      - "8600:8600/udp"  # Consul DNS
      - "8600:8600/tcp"  # Consul DNS
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
      - CONSUL_DATACENTER=${CONSUL_DATACENTER:-dc1}
      - CONSUL_BOOTSTRAP_EXPECT=1
      - CONSUL_ACL_ENABLED=false
      - CONSUL_ENABLE_UI=true
    volumes:
      - consul_data:/consul/data
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "-O", "/dev/null", "http://localhost:8500/v1/status/leader"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - symphainy_net

  traefik:
    image: traefik:v3.0
    container_name: symphainy-traefik
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"      # HTTP
      - "${TRAEFIK_HTTPS_PORT:-443}:443"   # HTTPS
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"  # Traefik Dashboard
    command:
      - --api.dashboard=true
      - --api.insecure=true  # Secure in production
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=symphainy_net
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --log.level=INFO
      - --accesslog=true
      - --providers.docker.watch=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - symphainy_net
    depends_on:
      - consul
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "-O", "/dev/null", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  tempo:
    image: grafana/tempo:latest
    container_name: symphainy-tempo
    ports:
      - "${TEMPO_PORT:-3200}:3200"   # Tempo UI
      - "4319:4317"   # OTLP gRPC (internal 4317, external 4319)
      - "4320:4318"   # OTLP HTTP (internal 4318, external 4320)
    volumes:
      - ./tempo-config.yaml:/etc/tempo.yaml:ro
      - tempo_data:/var/tempo
    command: -config.file=/etc/tempo.yaml
    networks:
      - symphainy_net
    depends_on:
      - consul
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "-O", "/dev/null", "http://localhost:3200/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: symphainy-otel-collector
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus metrics
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    command: ["--config=/etc/otel-collector-config.yaml"]
    networks:
      - symphainy_net
    depends_on:
      tempo:
        condition: service_started
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: symphainy-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus-config.yaml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - symphainy_net
    depends_on:
      - otel-collector
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "-O", "/dev/null", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: symphainy-grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - symphainy_net
    depends_on:
      - tempo
      - otel-collector
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "-O", "/dev/null", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # PLATFORM SERVICES
  # ============================================================================
  
  runtime:
    build:
      context: .
      dockerfile: Dockerfile.runtime
    container_name: symphainy-runtime
    ports:
      - "${RUNTIME_PORT:-8000}:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGO_URL=http://arango:8529
      - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
      arango:
        condition: service_started
      consul:
        condition: service_healthy
      otel-collector:
        condition: service_started
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - symphainy_net
    labels:
      - "traefik.enable=true"
      # Runtime API routes
      - "traefik.http.routers.runtime.rule=PathPrefix(`/api/runtime`) || PathPrefix(`/api/intent`) || PathPrefix(`/api/session`) || PathPrefix(`/api/execution`) || PathPrefix(`/api/realms`)"
      - "traefik.http.routers.runtime.entrypoints=web"
      - "traefik.http.routers.runtime.service=runtime"
      - "traefik.http.services.runtime.loadbalancer.server.port=8000"
      - "traefik.http.routers.runtime.priority=10"
      # Health endpoint (no auth)
      - "traefik.http.routers.runtime-health.rule=Path(`/health`) || Path(`/api/health`)"
      - "traefik.http.routers.runtime-health.entrypoints=web"
      - "traefik.http.routers.runtime-health.service=runtime"
      - "traefik.http.routers.runtime-health.priority=99"

  experience:
    build:
      context: .
      dockerfile: Dockerfile.experience
    container_name: symphainy-experience
    ports:
      - "${EXPERIENCE_PORT:-8001}:8001"
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGO_URL=http://arango:8529
      - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - RUNTIME_URL=http://runtime:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_JWKS_URL=${SUPABASE_JWKS_URL}
      - SUPABASE_JWT_ISSUER=${SUPABASE_JWT_ISSUER}
      - GCS_PROJECT_ID=${GCS_PROJECT_ID}
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - GCS_CREDENTIALS_JSON=${GCS_CREDENTIALS_JSON}
    depends_on:
      runtime:
        condition: service_healthy
      redis:
        condition: service_healthy
      arango:
        condition: service_started
      consul:
        condition: service_healthy
      otel-collector:
        condition: service_started
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - symphainy_net
    labels:
      - "traefik.enable=true"
      # Experience API routes (sessions, intents, admin dashboard)
      - "traefik.http.routers.experience.rule=PathPrefix(`/api/sessions`) || PathPrefix(`/api/intent`) || PathPrefix(`/api/ws`) || PathPrefix(`/api/admin`)"
      - "traefik.http.routers.experience.entrypoints=web"
      - "traefik.http.routers.experience.service=experience"
      - "traefik.http.services.experience.loadbalancer.server.port=8001"
      - "traefik.http.routers.experience.priority=10"
      # Health endpoint (no auth)
      - "traefik.http.routers.experience-health.rule=Path(`/health`)"
      - "traefik.http.routers.experience-health.entrypoints=web"
      - "traefik.http.routers.experience-health.service=experience"
      - "traefik.http.routers.experience-health.priority=99"

  smart-city:
    build:
      context: .
      dockerfile: Dockerfile.smart-city
    container_name: symphainy-smart-city
    ports:
      - "${SMART_CITY_PORT:-8001}:8001"
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGO_URL=http://arango:8529
      - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
      - RUNTIME_URL=http://runtime:8000
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      runtime:
        condition: service_started
      redis:
        condition: service_healthy
      arango:
        condition: service_started
      consul:
        condition: service_healthy
      otel-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - symphainy_net

  realms:
    build:
      context: .
      dockerfile: Dockerfile.realms
    container_name: symphainy-realms
    ports:
      - "${REALMS_PORT:-8002}:8002"
    environment:
      - REDIS_URL=redis://redis:6379
      - ARANGO_URL=http://arango:8529
      - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-changeme}
      - RUNTIME_URL=http://runtime:8000
      - SMART_CITY_URL=http://smart-city:8001
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      runtime:
        condition: service_started
      smart-city:
        condition: service_started
      redis:
        condition: service_healthy
      arango:
        condition: service_started
      consul:
        condition: service_healthy
      otel-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - symphainy_net

  frontend:
    build:
      context: ./symphainy-frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://35.215.64.103
        - NEXT_PUBLIC_BACKEND_URL=http://35.215.64.103
        - NEXT_PUBLIC_API_BASE_URL=http://35.215.64.103
    container_name: symphainy-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://35.215.64.103
      - NEXT_PUBLIC_BACKEND_URL=http://35.215.64.103
      - NEXT_PUBLIC_API_BASE_URL=http://35.215.64.103
      - NEXT_PUBLIC_FRONTEND_URL=http://35.215.64.103
      - PORT=3000
      - HOSTNAME=0.0.0.0
    depends_on:
      runtime:
        condition: service_healthy
      experience:
        condition: service_healthy
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - symphainy_net
    labels:
      - "traefik.enable=true"
      # Frontend routes - catch-all for non-API paths (lowest priority)
      - "traefik.http.routers.frontend.rule=!PathPrefix(`/api`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.service=frontend"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.http.routers.frontend.priority=1"

volumes:
  redis_data:
  arango_data:
  consul_data:
  tempo_data:
  prometheus_data:
  grafana_data:

networks:
  symphainy_net:
    driver: bridge
